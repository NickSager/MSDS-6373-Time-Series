---
title: "Time Series Project"
subtitle: "Spring 2024"
author: "Nicholas Sager, Anishka Peter"
date: last-modified
format: 
  html: 
    toc: true
    toc-location: left
    toc-depth: 4
    embed-resources: true
    # self-contained-math: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(tswge)
library(nnfor)
library(vars)
library(tseries)
# library(orcutt)
```

## Data
Introduce dataset, response variable, and scenario.
ACFs and Spectral Density plots.
```{r}
library(dplyr)
library(lubridate)
bike_data <- read_csv("https://raw.githubusercontent.com/NickSager/MSDS-6373-Time-Series/master/Project/bike_data.csv")

plotts.sample.wge(bike_data$`Total Users`)$xbar

# make the bike data daily instead of hourly 
daily_bike_data <- bike_data %>%
  group_by(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  summarise(
    Season = mean(Season),
    Hour = mean(Hour),
    Holiday = mean(Holiday),
    Day_of_the_Week = mean(`Day of the Week`),
    Working_Day = mean(`Working Day`),
    Weather_Type = mean(`Weather Type`),
    Temperature = mean(`Temperature F`),
    Temperature_Feels = mean(`Temperature Feels F`),
    Humidity = mean(Humidity),
    Wind_Speed = mean(`Wind Speed`),
    Casual_Users = sum(`Casual Users`),
    Registered_Users = sum(`Registered Users`),
    Total_Users = sum(`Total Users`), 
  )

plotts.sample.wge(daily_bike_data$Total_Users)$xbar
```


## Models
### Univariate: At least 2 candidate ARMA / ARIMA models

#### ARMA Model 
```{r}
# create model 
plotts.sample.wge(daily_bike_data$Total_Users)$xbar # looking at the spectral density it looks like there may be wandering behavior
plotts.wge(daily_bike_data$Total_Users)
parzen.wge(daily_bike_data$Total_Users)
aic5.wge(daily_bike_data$Total_Users,type = 'aic', p = 0:10) # bic picked p = 7 and q = 0
arma_est = est.arma.wge(daily_bike_data$Total_Users, p = 4, q = 1)

arma_est$aic
# Checking the residuals to see if the model is appropriate 
plotts.wge(arma_est$res) # looks random
acf(arma_est$res) # all acfs are within the bounds 
ljung.wge(arma_est$res) # greater than 0.05
ljung.wge(arma_est$res, K =48) # greater than 0.05

arma_gen1 = gen.aruma.wge(200, phi = arma_est$phi, theta = arma_est$theta)
arma_gen2 = gen.arima.wge(200, phi = arma_est$phi, theta = arma_est$theta)
arma_gen3 = gen.arima.wge(200, phi = arma_est$phi, theta = arma_est$theta)
arma_gen4 = gen.arima.wge(200, phi = arma_est$phi, theta = arma_est$theta)
plotts.sample.wge(arma_gen1)$xbar
plotts.sample.wge(arma_gen2)$xbar
plotts.sample.wge(arma_gen3)$xbar
plotts.sample.wge(arma_gen4)$xbar # all these 4 random realizations have the same behavior as the original data so the model seems to be appropriate

# Compare Spectral Densities: 
sims = 20
SpecDen = parzen.wge(daily_bike_data$Total_Users, plot = "FALSE")
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 6, main = '20 Spectral Densities for ARMA(4,1)')

for( i in 1: sims){
   SpecDen2 = parzen.wge(gen.aruma.wge(length(daily_bike_data$Total_Users), phi = arma_est$phi, theta = arma_est$theta, plot ="FALSE"), plot = "FALSE")
   lines(SpecDen2$freq,SpecDen2$pzgram, lwd = 2, col = "red")
}

# Compare ACFs:
sims = 20
ACF = acf(daily_bike_data$Total_Users, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 6, main = '20 ACFs for ARMA(4,1)')

for( i in 1: sims)
{
   ACF2 = acf(gen.aruma.wge(length(daily_bike_data$Total_Users), phi = arma_est$phi, theta = arma_est$theta, plot ="FALSE"), plot = "FALSE")
   lines(ACF2$lag ,ACF2$acf, lwd = 2, col = "red")
}
```
$$\phi(B) = \theta(B)$$
$$(1-1.3314B+0.3662B^2+0.0398B^3-0.0714B^4) = (1 - 0.8546B)$$

```{r}
# plot of Last N forecasts for short and long term horizon 
arma_stfore1 = fore.arima.wge(daily_bike_data$Total_Users, phi = arma_est$phi, theta = arma_est$theta, n.ahead = 7, lastn = TRUE)
arma_ltfore1 = fore.arima.wge(daily_bike_data$Total_Users, phi = arma_est$phi, theta = arma_est$theta, n.ahead = 60, lastn = TRUE)

t = 1:length(daily_bike_data$Total_Users)
plot(t[720:731],daily_bike_data$Total_Users[720:731], type = 'l', xlab = "Time", ylab = "Total Users", main = 'Last 7 Forecasts')
points(t[725:731], arma_stfore1$f, type="l", lwd=2, lty = 2, col = 'blue')

plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', xlab = "Time", ylab = "Total Users", main = 'Last 60 Forecasts')
points(t[672:731], arma_ltfore1$f, type="l", lwd=2, lty = 2,col = 'blue')

# ASE 
arma_stASE = mean((daily_bike_data$Total_Users[725:731]-arma_stfore1$f)^2)
arma_ltASE = mean((daily_bike_data$Total_Users[672:731]-arma_ltfore1$f)^2)
arma_stASE
arma_ltASE

# Rolling Window RMSE
# RW-RMSE commented out due to obscene amount of unsupressable output
# arma_strwRMSE = roll.win.rmse.wge(daily_bike_data$Total_Users, horizon = 7, phi = arma_est$phi, theta = arma_est$theta)$rwRMSE
# arma_ltrwRMSE = roll.win.rmse.wge(daily_bike_data$Total_Users, horizon = 60, phi = arma_est$phi, theta = arma_est$theta)$rwRMSE

arma_strwRMSE = 991.812
arma_ltrwRMSE = 1224.59

arma_stfore2 = fore.arima.wge(daily_bike_data$Total_Users, phi = arma_est$phi, theta = arma_est$theta, n.ahead = 7)
arma_ltfore2 = fore.arima.wge(daily_bike_data$Total_Users, phi = arma_est$phi, theta = arma_est$theta, n.ahead = 60)


# Plots of the short and Long Term Forecasts  
t = 1:800
plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', xlim = c(670,745), xlab = "Time", ylab = "Total Users", main = '7 Day Forecast ARMA(4,1)')
points(t[732:738],arma_stfore2$f, type = 'l', col = 'blue')
points(t[732:738],arma_stfore2$ll, type = 'l',lwd=2, lty = 2, col = 'red')
points(t[732:738],arma_stfore2$ul, type = 'l',lwd=2, lty = 2, col = 'red')


plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', xlim = c(670,795), xlab = "Time", ylab = "Total Users", main = '60 Day Forecast ARMA(4,1)')
points(t[732:791],arma_ltfore2$f, type = 'l', col = 'blue')
points(t[732:791],arma_ltfore2$ll, type = 'l',lwd=2, lty = 2, col = 'red')
points(t[732:791],arma_ltfore2$ul, type = 'l',lwd=2, lty = 2, col = 'red')

```

#### Non-Seasonal ARIMA Model
```{r}
# Check if the data could be stationary
adf.test(daily_bike_data$Total_Users) # p-value 0.7, data not likely stationary

# Difference of 1
total_d1 = artrans.wge(daily_bike_data$Total_Users, phi.tr = c(1))

# Model the residuals
aic5.wge(total_d1, type = 'bic') # bic and aic pick p = 1 and q = 1
est = est.arma.wge(total_d1, p = 1, q = 1)
plotts.sample.wge(est$res, arlimits = TRUE)$xbar # appears to be white noise
ljung.wge(est$res) # FTR
ljung.wge(est$res, K = 48) # Reject. Mixed evidence.

# Generate realizations for comparison
arima_gen1 = gen.arima.wge(200, phi = est$phi, theta = est$theta, d = 1)
arima_gen2 = gen.arima.wge(200, phi = est$phi, theta = est$theta, d = 1)
arima_gen3 = gen.arima.wge(200, phi = est$phi, theta = est$theta, d = 1)
arima_gen4 = gen.arima.wge(200, phi = est$phi, theta = est$theta, d = 1)
plotts.sample.wge(arima_gen1)$xbar
plotts.sample.wge(arima_gen2)$xbar
plotts.sample.wge(arima_gen3)$xbar
plotts.sample.wge(arima_gen4)$xbar # Similar behavior to original data

# Compare Spectral Densities: 
sims = 20
SpecDen = parzen.wge(daily_bike_data$Total_Users, plot = "FALSE")
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 6)

for( i in 1: sims)
{
   SpecDen2 = parzen.wge(gen.aruma.wge(length(daily_bike_data$Total_Users), d = 1, phi = est$phi, theta = est$theta, plot ="FALSE"), plot = "FALSE")
   lines(SpecDen2$freq,SpecDen2$pzgram, lwd = 2, col = "red")
}

# Compare ACFs:
sims = 20
ACF = acf(daily_bike_data$Total_Users, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 6)

for( i in 1: sims)
{
   ACF2 = acf(gen.aruma.wge(length(daily_bike_data$Total_Users), d = 1, phi = est$phi, theta = est$theta, plot ="FALSE"), plot = "FALSE")
   lines(ACF2$lag ,ACF2$acf, lwd = 2, col = "red")
}

# Short and Long Term Forecasts
fore_arima_st = fore.arima.wge(daily_bike_data$Total_Users, phi = est$phi, theta = est$theta, d = 1, n.ahead = 7, lastn = TRUE)
fore_arima_lt = fore.arima.wge(daily_bike_data$Total_Users, phi = est$phi, theta = est$theta, d = 1, n.ahead = 60, lastn = TRUE)

# Plot Forecasts and CI
t = 1:length(daily_bike_data$Total_Users)
plot(t[720:731],daily_bike_data$Total_Users[720:731], type = 'l', xlab = "Time", ylab = "Total Users")
points(t[725:731], fore_arima_st$f, type="l", lwd=2, lty = 2, col = 'blue')

plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', xlab = "Time", ylab = "Total Users")
points(t[672:731], fore_arima_lt$f, type="l", lwd=2, lty = 2,col = 'blue')

# ASE 
arima_stASE = mean((daily_bike_data$Total_Users[725:731]-fore_arima_st$f)^2)
arima_ltASE = mean((daily_bike_data$Total_Users[672:731]-fore_arima_lt$f)^2)
arima_stASE
arima_ltASE

# Rolling Window RMSE
# RW-RMSE commented out due to obscene amount of unsupressable output
# arima_strwRMSE = roll.win.rmse.wge(daily_bike_data$Total_Users, horizon = 7, phi = est$phi, theta = est$theta, d = 1)$rwRMSE
# arima_ltrwRMSE = roll.win.rmse.wge(daily_bike_data$Total_Users, horizon = 60, phi = est$phi, theta = est$theta, d = 1)$rwRMSE
arima_strwRMSE = 1237.393
arima_ltrwRMSE = 1503.197

# Plots of the short and Long Term Forecasts  
fore_arima_st_2 = fore.arima.wge(daily_bike_data$Total_Users, phi = est$phi, theta = est$theta, d = 1, n.ahead = 7)
fore_arima_lt_2 = fore.arima.wge(daily_bike_data$Total_Users, phi = est$phi, theta = est$theta, d = 1, n.ahead = 60)

t = 1:800
plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', main = "Short Term Forecast", xlim = c(670,795), xlab = "Time", ylab = "Total Users")
points(t[732:738],fore_arima_st_2$f, type = 'l', col = 'blue')
points(t[732:738],fore_arima_st_2$ll, type = 'l',lwd=2, lty = 2, col = 'red')
points(t[732:738],fore_arima_st_2$ul, type = 'l',lwd=2, lty = 2, col = 'red')


plot(t[670:731],daily_bike_data$Total_Users[670:731], type = 'l', main = "Long Term Forecast", xlim = c(670,795), xlab = "Time", ylab = "Total Users")
points(t[732:791],fore_arima_lt_2$f, type = 'l', col = 'blue')
points(t[732:791],fore_arima_lt_2$ll, type = 'l',lwd=2, lty = 2, col = 'red')
points(t[732:791],fore_arima_lt_2$ul, type = 'l',lwd=2, lty = 2, col = 'red')
```



a.	The models in factored form or at least separate the stationary and non-
stationary factors with standard deviation or variance of the white noise.
b.	AIC
c.	ASE (short and long term forecasts)
d.	Rolling Window RMSE (short and long term forecasts)
e.	At least 10 superimposed spectral densities from 10 generated 
realizations like we did in Unit 11.  Use these to help choose between the at least two candidate univariate models. 
f.	Visualization of Forecasts for both the short- and long-term Horizons. 
g.	Be sure and include confidence intervals when possible (I don’t have 
code for confidence intervals from MLP models at the moment… but that would be a good thing to work on!  )

### Multivariate: At least one multivariate model (VAR or MLR with Correlated Errors)
i.	Include an ASE (rolling window is not yet available in multivariate models)
  1.	Short Horizon (you pick the length.. could be one step ahead)
  2.	Long Horizon (you pick ... just must be longer than the short horizon.)
ii.	Describe the explanatory variable(s) used in the model and why you felt they were significant / important.
iii.	Visualization of Forecasts for both the short- and long-Horizons.
iv.	Be sure and include confidence intervals if using VAR … 


```{r}
ccf(daily_bike_data$Total_Users,daily_bike_data$Humidity) # no lag 
daily_bike_data$Humidity_lag = dplyr::lag(daily_bike_data$Humidity,4)

# Short Term Prediction Fit
fit1 = lm(Total_Users~Humidity + Temperature + Day_of_the_Week + Wind_Speed, data = daily_bike_data[1:724,])

plotts.sample.wge(fit1$residuals)$xbar
aic5.wge(fit1$residuals, type = 'bic')
aic5.wge(fit1$residuals, type = 'aic')
mlr1 = arima(daily_bike_data$Total_Users[1:724], order = c(2,0,1),xreg = cbind(daily_bike_data$Humidity[1:724], daily_bike_data$Temperature[1:724], daily_bike_data$Day_of_the_Week[1:724], daily_bike_data$Wind_Speed[1:724]))


plotts.wge(mlr1$residuals) # looks random
acf(mlr1$residuals) # none of the acfs out of bounds 
ljung.wge(mlr1$residuals) # greater than 0.05
ljung.wge(mlr1$residuals, K =48)

AIC(fit1)
mlr_st_pred = predict(mlr1, newxreg = data.frame(daily_bike_data$Humidity[725:731], daily_bike_data$Temperature[725:731], daily_bike_data$Day_of_the_Week[725:731], daily_bike_data$Wind_Speed[725:731]), n.ahead = 7)

plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(720,731), xlab='Time', main = 'Last 7 Day Forecast', ylab = 'Total Users')
points(seq(725,731,1),mlr_st_pred$pred,type = 'l', col = 'blue')

mlr_st_ASE= mean((daily_bike_data$Total_Users[725:731] - mlr_st_pred$pred)^2)

mlr_st_ASE

# Long Term Prediction Fit
fit2 = lm(Total_Users~Humidity + Temperature + Day_of_the_Week + Wind_Speed, data = daily_bike_data[1:671,])


plotts.sample.wge(fit2$residuals)$xbar
aic5.wge(fit2$residuals, type = 'bic')

mlr2 = arima(daily_bike_data$Total_Users[1:671], order = c(2,0,1),xreg = cbind(daily_bike_data$Humidity[1:671], daily_bike_data$Temperature[1:671], daily_bike_data$Day_of_the_Week[1:671], daily_bike_data$Wind_Speed[1:671]))

plotts.wge(mlr2$residuals) # looks random
acf(mlr2$residuals[-(1:5)]) # 0/20 acfs out of bounds 
ljung.wge(mlr2$residuals) # greater than 0.05
ljung.wge(mlr2$residuals, K =48)

mlr_lt_pred = predict(mlr2, newxreg = data.frame(daily_bike_data$Humidity[672:731], daily_bike_data$Temperature[672:731], daily_bike_data$Day_of_the_Week[672:731], daily_bike_data$Wind_Speed[672:731]), n.ahead = 60)

plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(670,731),xlab='Time', main = 'Last 60 Day Forecast', ylab = "Total Users")
points(seq(672,731,1),mlr_lt_pred$pred,type = 'l', pch = 15,col = 'blue',lwd=1, lty = 1)

mlr_lt_ASE= mean((daily_bike_data$Total_Users[672:731] - mlr_lt_pred$pred)^2)

mlr_lt_ASE




# Forecasting The 4 Exogenous Variables 

parzen.wge(daily_bike_data$Humidity, trunc = 300)
humdiff = artrans.wge(daily_bike_data$Humidity, phi.tr = c(rep(0,364),1))
aic5.wge(humdiff, type = 'aic')
hum = est.arma.wge(humdiff, p = 2, q = 2)
acf(hum$res)
ljung.wge(hum$res) #  Fail to reject  
ljung.wge(hum$res, K=48) # Fail to reject
preds_Humidity = fore.arima.wge(daily_bike_data$Humidity, s = 365, phi = hum$phi, theta = hum$theta, n.ahead = 365)

parzen.wge(daily_bike_data$Temperature, trunc = 300)
tempdiff = artrans.wge(daily_bike_data$Temperature, phi.tr = c(rep(0,364),1))
plotts.sample.wge(tempdiff)
aic5.wge(tempdiff, type = 'bic') # bic picked p = 1 and q = 1
temp = est.arma.wge(tempdiff, p = 1, q = 1)
acf(temp$res)
ljung.wge(temp$res) # close to 0.05 but Fail to reject  
ljung.wge(temp$res, K=48) # Fail to reject
preds_Temperature = fore.arima.wge(daily_bike_data$Temperature, s = 365, phi = temp$phi, theta = temp$theta, n.ahead = 365)

sequence_length <- 366
pred_Days_of_the_Week <- (2:sequence_length) %% 7

plotts.sample.wge(daily_bike_data$Wind_Speed, trunc = 300)
winddiff = artrans.wge(daily_bike_data$Wind_Speed, phi.tr = c(rep(0,364),1))
aic5.wge(winddiff, type = 'bic') # bic and aic picked p = 0 and q = 1
wind = est.arma.wge(winddiff, p = 0, q = 1)
acf(wind$res)
ljung.wge(wind$res) #  Fail to reject  
ljung.wge(wind$res, K=48) # Fail to reject
preds_Wind_Speed = fore.arima.wge(daily_bike_data$Wind_Speed, s = 365, phi = wind$phi, theta = wind$theta, n.ahead = 365)

ahead = cbind(Humidity = preds_Humidity$f,Temperature = preds_Temperature$f,Days_of_the_Week = pred_Days_of_the_Week, Wind_Speed = preds_Wind_Speed$f)

fit3 = lm(Total_Users~Humidity + Temperature + Day_of_the_Week + Wind_Speed, data = daily_bike_data)
aic5.wge(fit3$residuals, type = 'bic')
aic5.wge(fit3$residuals, type = 'aic')
mlr_forecast = arima(daily_bike_data$Total_Users, order = c(2,0,1),xreg = cbind(daily_bike_data$Humidity, daily_bike_data$Temperature, daily_bike_data$Day_of_the_Week, daily_bike_data$Wind_Speed))

plotts.wge(mlr_forecast$residuals) # looks random
acf(mlr_forecast$residuals) # 0/20 acfs out of bounds 
ljung.wge(mlr_forecast$residuals) # greater than 0.05
ljung.wge(mlr_forecast$residuals, K =48)


mlr_st_pred2 = predict(mlr_forecast, newxreg = ahead[1:7,], n.ahead = 7, lastn= FALSE)
plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(720,738), main = "7 day MLR Forecast", xlab = 'Time', ylab = 'Total Users')
points(seq(732,738,1),mlr_st_pred2$pred,type = 'l', pch = 15,col = 'blue',lwd=2, lty = 2)

mlr_st_ASE2= mean((daily_bike_data$Total_Users[725:731] - mlr_st_pred2$pred)^2)
mlr_st_ASE2



mlr_lt_pred2 = predict(mlr_forecast, newxreg = ahead[1:60,], n.ahead = 60, lastn= FALSE)
plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(700,785), main = "60 day MLR Forecast", xlab = 'Time', ylab = 'Total Users')
points(seq(732,791,1),mlr_lt_pred2$pred,type = 'l', pch = 1,col = 'blue',lwd=2, lty = 2)

mlr_lt_ASE2= mean((daily_bike_data$Total_Users[672:731] - mlr_lt_pred2$pred)^2)
mlr_lt_ASE2


# Year Out Forecast
mlr_lt_pred3 = predict(mlr_forecast, newxreg = ahead[1:365,], n.ahead = 365, lastn= FALSE)
plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(1,1100), main = "365 day MLR Forecast", xlab = 'Time', ylab = 'Total Users')
points(seq(732,1096,1),mlr_lt_pred3$pred,type = 'l', pch = 1,col = 'blue',lwd=1, lty = 1)

```


### MLP Model
i.	ASE (short and long term forecasts)
ii.	Rolling Window RMSE (short and long term forecasts (only if univariate)
iii.	Visualization of Forecasts for both the short- and long-term Horizons. 
iv.	Confidence / Prediction intervals are not required (I don’t have 
code for confidence / prediction intervals (bootstrap intervals) for MLP models at the moment… but that would be a good thing to work on!  )
```{r}
# Convert tibble to a data frame with ts() objects
bike_DF <- daily_bike_data %>%
  dplyr::select(-c(Date, Hour, Holiday, Temperature_Feels, Casual_Users, Registered_Users)) %>%  # Remove unnecessary columns
  mutate(across(everything(), ~ zoo(.x, order.by = daily_bike_data$Date))) %>%  # Convert each column to a zoo object
  mutate(across(everything(), ~ as.ts(.x))) %>%  # Convert zoo objects to ts objects
  as.data.frame()  # Convert the tibble to a data frame

bikeShortTrain = bike_DF[1:724,]
bikeShortTest = bike_DF[725:731,]
bikeLongTrain = bike_DF[1:671,]
bikeLongTest = bike_DF[672:731,]
seed = 137
```
```{r}
# Forecast Short-term predictor variables using MLP
set.seed(seed)
fit.mlp.short.Season = mlp(ts(bikeShortTrain[,"Season"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Season = forecast(fit.mlp.short.Season, h = 7)
plot(fore.mlp.short.Season)

fit.mlp.short.Day_of_the_Week = mlp(ts(bikeShortTrain[,"Day_of_the_Week"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Day_of_the_Week = forecast(fit.mlp.short.Day_of_the_Week, h = 7)
fore.mlp.short.Day_of_the_Week$mean = round(fore.mlp.short.Day_of_the_Week$mean) # Round to nearest whole number
plot(fore.mlp.short.Day_of_the_Week)

fit.mlp.short.Working_Day = mlp(ts(bikeShortTrain[,"Working_Day"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Working_Day = forecast(fit.mlp.short.Working_Day, h = 7)
fore.mlp.short.Working_Day$mean = round(fore.mlp.short.Working_Day$mean) # Round to nearest whole number
plot(fore.mlp.short.Working_Day)

# fit.mlp.short.Weather_Type = mlp(ts(bikeShortTrain[,"Weather_Type"]),reps = 5, difforder = 0, comb = "mean", det.type = "auto")
# fore.mlp.short.Weather_Type = forecast(fit.mlp.short.Weather_Type, h = 7)
# plot(fore.mlp.short.Weather_Type)

fit.mlp.short.Temperature = mlp(ts(bikeShortTrain[,"Temperature"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Temperature = forecast(fit.mlp.short.Temperature, h = 7)
plot(fore.mlp.short.Temperature)

fit.mlp.short.Humidity = mlp(ts(bikeShortTrain[,"Humidity"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Humidity = forecast(fit.mlp.short.Humidity, h = 7)
plot(fore.mlp.short.Humidity)

fit.mlp.short.Wind_Speed = mlp(ts(bikeShortTrain[,"Wind_Speed"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.short.Wind_Speed = forecast(fit.mlp.short.Wind_Speed, h = 7)
plot(fore.mlp.short.Wind_Speed)
```
```{r}
# Forecast Long-term predictor variables using MLP
set.seed(seed)
fit.mlp.long.Season = mlp(ts(bikeLongTrain[,"Season"]),reps = 10, difforder = 0, comb = "median", det.type = "bin")
fore.mlp.long.Season = forecast(fit.mlp.long.Season, h = 60)
plot(fore.mlp.long.Season)

fit.mlp.long.Day_of_the_Week = mlp(ts(bikeLongTrain[,"Day_of_the_Week"]),reps = 10, difforder = 0, comb = "median", det.type = "bin")
fore.mlp.long.Day_of_the_Week = forecast(fit.mlp.long.Day_of_the_Week, h = 60)
fore.mlp.long.Day_of_the_Week$mean = round(fore.mlp.long.Day_of_the_Week$mean) # Round to nearest whole number
plot(fore.mlp.long.Day_of_the_Week)

fit.mlp.long.Working_Day = mlp(ts(bikeLongTrain[,"Working_Day"]),reps = 10, difforder = 0, comb = "median", det.type = "bin")
fore.mlp.long.Working_Day = forecast(fit.mlp.long.Working_Day, h = 60)
fore.mlp.long.Working_Day$mean = round(fore.mlp.long.Working_Day$mean) # Round to nearest whole number
plot(fore.mlp.long.Working_Day)

# fit.mlp.long.Weather_Type = mlp(ts(bikeLongTrain[,"Weather_Type"]),reps = 10, difforder = 0, comb = "mean", det.type = "auto")
# fore.mlp.long.Weather_Type = forecast(fit.mlp.long.Weather_Type, h = 60)
# plot(fore.mlp.long.Weather_Type)

fit.mlp.long.Temperature = mlp(ts(bikeLongTrain[,"Temperature"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.long.Temperature = forecast(fit.mlp.long.Temperature, h = 60)
plot(fore.mlp.long.Temperature)

fit.mlp.long.Humidity = mlp(ts(bikeLongTrain[,"Humidity"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.long.Humidity = forecast(fit.mlp.long.Humidity, h = 60)
plot(fore.mlp.long.Humidity)

fit.mlp.long.Wind_Speed = mlp(ts(bikeLongTrain[,"Wind_Speed"]),reps = 10, difforder = 0, comb = "mean", det.type = "bin")
fore.mlp.long.Wind_Speed = forecast(fit.mlp.long.Wind_Speed, h = 60)
plot(fore.mlp.long.Wind_Speed)
```
```{r}
# Pack into data frames
BDF_fore_short = data.frame(Day = ts(seq(1,731,1)),
                            Season = ts(c(bikeShortTrain$Season,fore.mlp.short.Season$mean)),
                            Day_of_the_Week = ts(c(bikeShortTrain$Day_of_the_Week,fore.mlp.short.Day_of_the_Week$mean)),
                            Working_Day = ts(c(bikeShortTrain$Working_Day,fore.mlp.short.Working_Day$mean)),
                            # Weather_Type = ts(c(bikeShortTrain$Weather_Type,fore.mlp.short.Weather_Type$mean)),
                            Temperature = ts(c(bikeShortTrain$Temperature,fore.mlp.short.Temperature$mean)),
                            Humidity = ts(c(bikeShortTrain$Humidity,fore.mlp.short.Humidity$mean)),
                            Wind_Speed = ts(c(bikeShortTrain$Wind_Speed,fore.mlp.short.Wind_Speed$mean)))
BDF_fore_long = data.frame(Day = ts(seq(1,731,1)),
                            Season = ts(c(bikeLongTrain$Season,fore.mlp.long.Season$mean)),
                            Day_of_the_Week = ts(c(bikeLongTrain$Day_of_the_Week,fore.mlp.long.Day_of_the_Week$mean)),
                            Working_Day = ts(c(bikeLongTrain$Working_Day,fore.mlp.long.Working_Day$mean)),
                            # Weather_Type = ts(c(bikeLongTrain$Weather_Type,fore.mlp.long.Weather_Type$mean)),
                            Temperature = ts(c(bikeLongTrain$Temperature,fore.mlp.long.Temperature$mean)),
                            Humidity = ts(c(bikeLongTrain$Humidity,fore.mlp.long.Humidity$mean)),
                            Wind_Speed = ts(c(bikeLongTrain$Wind_Speed,fore.mlp.long.Wind_Speed$mean)))

BDF_xreg_short = data.frame(Day = ts(seq(1,724,1)),
                            Season = ts(c(bikeShortTrain$Season)),
                            Day_of_the_Week = ts(c(bikeShortTrain$Day_of_the_Week)),
                            Working_Day = ts(c(bikeShortTrain$Working_Day)),
                            # Weather_Type = ts(c(bikeShortTrain$Weather_Type)),
                            Temperature = ts(c(bikeShortTrain$Temperature)),
                            Humidity = ts(c(bikeShortTrain$Humidity)),
                            Wind_Speed = ts(c(bikeShortTrain$Wind_Speed)))
BDF_xreg_long = data.frame(Day = ts(seq(1,671,1)),
                            Season = ts(c(bikeLongTrain$Season)),
                            Day_of_the_Week = ts(c(bikeLongTrain$Day_of_the_Week)),
                            Working_Day = ts(c(bikeLongTrain$Working_Day)),
                            # Weather_Type = ts(c(bikeLongTrain$Weather_Type)),
                            Temperature = ts(c(bikeLongTrain$Temperature)),
                            Humidity = ts(c(bikeLongTrain$Humidity)),
                            Wind_Speed = ts(c(bikeLongTrain$Wind_Speed)))

# Fit MLP model for Total_Users
set.seed(seed)
fit.mlp.st = mlp(ts(bikeShortTrain$Total_Users),reps = 10, comb = "median",xreg = BDF_xreg_short, allow.det.season = TRUE, det.type = "bin")
fit.mlp.lt = mlp(ts(bikeLongTrain$Total_Users),reps = 10, comb = "median",xreg = BDF_xreg_long, allow.det.season = TRUE, det.type = "bin")
plot(fit.mlp.lt)

# Forecast and evaluate ASE for short and long
fore.mlp.st = forecast(fit.mlp.st, h = 7, xreg = BDF_fore_short)
fore.mlp.lt = forecast(fit.mlp.lt, h = 60, xreg = BDF_fore_long)
ASE.mlp.st = mean((bikeShortTest$Total_Users - fore.mlp.st$mean)^2)
ASE.mlp.lt = mean((bikeLongTest$Total_Users - fore.mlp.lt$mean)^2)
print(paste("MLP ASE Short Term: ", round(ASE.mlp.st, 2)))
print(paste("MLP ASE Long Term: ", round(ASE.mlp.lt, 2)))
plot(fore.mlp.st)
plot(fore.mlp.lt)

# Plot the forecasts
t = 1:731
plot(t[720:731],bike_DF$Total_Users[720:731], type = 'l', xlab = "Time", ylab = "Total Users", main = "MLP Short Term Forecast")
lines(t[725:731], fore.mlp.st$mean, type="l", lwd=2, lty = 2, col = 'blue')

plot(t[600:731],bike_DF$Total_Users[600:731], type = 'l', xlab = "Time", ylab = "Total Users", main = "MLP Long Term Forecast")
lines(t[672:731], fore.mlp.lt$mean, type="l", lwd=2, lty = 2, col = 'blue')
```

### Ensemble Model


```{r}
ensemble_st = (arma_stfore1$f + mlr_st_pred$pred)/2
ensemble_lt = (arma_stfore1$f + mlr_lt_pred$pred)/2

plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(720,731), xlab='Time', main = 'Last 7 Day Forecast', ylab = 'Total Users')
points(seq(725,731,1),ensemble_st,type = 'l', col = 'blue')

plot(seq(1,731,1),daily_bike_data$Total_Users,type = 'l',xlim = c(650,731), xlab='Time', main = 'Last 60 Day Forecast', ylab = 'Total Users')
points(seq(672,731,1),ensemble_lt,type = 'l', col = 'blue')

ensemble_st_ASE = mean((daily_bike_data$Total_Users[725:731] - ensemble_st)^2)
ensemble_lt_ASE = mean((daily_bike_data$Total_Users[672:731] - ensemble_lt)^2)
ensemble_st_ASE
ensemble_lt_ASE
```


## Model Comparison and Final Forecasts
i.	Provide a table comparing all models on at least ASE and rwRMSE (if available).
ii.	Include at least one ensemble model in addition to the models above.
iii.	Make a case as to why you feel one of your candidate models is the most useful.
iv.	Provide you final short and long term forecasts with that model. 
```{r Metrics Table Short, echo = FALSE, eval = TRUE}
library(knitr)
library(kableExtra)

# Create a data frame with the metrics
st_model_metrics <- data.frame(
  Model = c("ARMA", "ARIMA", "MLR-1", "MLR-2", "MLP", "Ensemble"),
  ASE = c(arma_stASE, arima_stASE, mlr_st_ASE, mlr_st_ASE2, ASE.mlp.st, ensemble_st_ASE),
  rwRMSE = c(arma_strwRMSE, arima_strwRMSE, NA, NA, NA, NA)
)

# Define helper function for conditional formatting
apply_conditional_formatting <- function(x){
  lapply(x, function(val){
    if (!is.na(val)){
      return(cell_spec(round(val, 2), 
          color = ifelse(val == min(st_model_metrics$ASE, na.rm = TRUE),
            "red", "black")))} else {return(NA)}
     })
 }

# Apply conditional formatting to the error columns
st_model_metrics$ASE <- unlist(apply_conditional_formatting(st_model_metrics$ASE))
st_model_metrics$rwRMSE <- unlist(apply_conditional_formatting(st_model_metrics$rwRMSE))

# Convert columns to character type with specified formatting
st_model_metrics$ASE <- formatC(st_model_metrics$ASE, big.mark = ",", format="f")
st_model_metrics$rwRMSE <- formatC(st_model_metrics$rwRMSE, big.mark = ",", format="f")

# Create and format the table
kable(st_model_metrics, format = "html", escape = F, caption = "Model Performance Metrics (Short-Term)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  column_spec(1, bold = T) %>%
  column_spec(2:3)
```

```{r Metrics Table Long, echo = FALSE, eval = TRUE}
library(knitr)
library(kableExtra)

# Create a data frame with the metrics
lt_model_metrics <- data.frame(
  Model = c("ARMA", "ARIMA", "MLR-1", "MLR-2", "MLP", "Ensemble"),
  ASE = c(arma_ltASE, arima_ltASE, mlr_lt_ASE, mlr_lt_ASE2, ASE.mlp.lt, ensemble_lt_ASE),
  rwRMSE = c(arma_ltrwRMSE, arima_ltrwRMSE, NA, NA, NA, NA)
)

# Define helper function for conditional formatting
apply_conditional_formatting <- function(x){
  lapply(x, function(val){
    if (!is.na(val)){
      return(cell_spec(round(val, 2), 
          color = ifelse(val == min(lt_model_metrics$ASE, na.rm = TRUE),
            "red", "black")))} else {return(NA)}
     })
 }

# Apply conditional formatting to the error columns
lt_model_metrics$ASE <- unlist(apply_conditional_formatting(lt_model_metrics$ASE))
lt_model_metrics$rwRMSE <- unlist(apply_conditional_formatting(lt_model_metrics$rwRMSE))

# Convert columns to character type with specified formatting
lt_model_metrics$ASE <- formatC(lt_model_metrics$ASE, big.mark = ",", format="f")
lt_model_metrics$rwRMSE <- formatC(lt_model_metrics$rwRMSE, big.mark = ",", format="f")

#FIXME: commas not working
# Create and format the table
kable(lt_model_metrics, format = "html", escape = F, caption = "Model Performance Metrics (Long-Term)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  column_spec(1, bold = T) %>%
  column_spec(2:3)
```


## Conclusion
